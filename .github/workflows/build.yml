on: [push, pull_request]

jobs:
    tests:
        runs-on: ubuntu-24.04
        name: Build
        steps:
            - name: "Checkout"
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: "Add gcc-15 PPA"
              run: |
                sudo add-apt-repository ppa:puni070/gcc-noble -y
                sudo apt update

            - name: "Install and cache C dependencies"
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                packages: >
                  gcc-15
                  libgtk-3-dev
                  libx11-dev
                  libjansson-dev
                  libluajit-5.1-dev
                version: 1.0

            - name: "Install Meson"
              run: sudo pip3 install meson

            - name: "Set up compiler"
              run: |
                sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-15 150
                sudo update-alternatives --set gcc /usr/bin/gcc-15

            - name: "Configure"
              run: meson setup build -Dbuildtype=release -Dprefix=/usr

            - name: "Build"
              run: meson compile -C build

            - name: Set Build number
              shell: bash
              run: echo "build_number=$(git rev-list HEAD --count)" >> $GITHUB_ENV

            - name: Compute git short sha
              shell: bash
              run: echo "git_short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

            - name: "Bundle extra files"
              run: |
                  rm -rf release
                  mkdir -p release
                  # Use meson install to stage the install tree for a relocatable release
                  meson install -C build --destdir=$(pwd)/release
                  # Include extra non-installed files
                  cp -r assets release/

            - name: "Upload artifacts"
              uses: actions/upload-artifact@v4
              with:
                  name: LibreSplit-${{ env.build_number }}-${{ env.git_short_sha }}
                  path: release/

    appimage:
        runs-on: ubuntu-24.04
        name: Build AppImage
        needs: tests
        steps:
            - name: "Checkout"
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: "Download build artifacts"
              uses: actions/download-artifact@v4
              with:
                  pattern: LibreSplit-*
                  merge-multiple: true
                  path: release

            - name: "Install AppImage dependencies"
              run: |
                  sudo apt -y update
                  sudo apt -y install desktop-file-utils libluajit-5.1-dev

            - name: Set Build number
              shell: bash
              run: echo "build_number=$(git rev-list HEAD --count)" >> $GITHUB_ENV

            - name: Compute git short sha
              shell: bash
              run: echo "git_short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

            - name: "Prepare AppDir from release artifact"
              run: |
                rm -rf AppDir
                mkdir -p AppDir

                if [ -d release ]; then
                  cp -a release/* AppDir/
                  rm -rf AppDir/assets
                else
                  echo "release directory not found; listing files:" && ls -la
                  exit 1
                fi

                mkdir -p AppDir/usr/share/applications
                cp assets/libresplit.desktop AppDir/
                cp assets/libresplit.desktop AppDir/usr/share/applications/
                sed -i 's/^Exec=.*/Exec=AppRun/' AppDir/libresplit.desktop
                cp assets/appimage.sh AppDir/AppRun
                cp assets/icons/libresplit-256.png AppDir/libresplit.png
                chmod +x AppDir/AppRun
                chmod +x AppDir/usr/bin/libresplit
                chmod +x AppDir/usr/bin/libresplit-ctl

            - name: "Download linuxdeploy"
              run: |
                  wget -O linuxdeploy-x86_64.AppImage https://github.com/linuxdeploy/linuxdeploy/releases/latest/download/linuxdeploy-x86_64.AppImage
                  chmod +x linuxdeploy-x86_64.AppImage

            - name: "Create AppImage"
              run: |
                  ./linuxdeploy-x86_64.AppImage --appdir AppDir --desktop-file AppDir/libresplit.desktop --icon-file AppDir/libresplit.png --output appimage

            - name: "Upload AppImage"
              uses: actions/upload-artifact@v4
              with:
                  path: LibreSplit-x86_64.AppImage
                  name: LibreSplit-${{ env.build_number }}-${{ env.git_short_sha }}-x86_64.AppImage
